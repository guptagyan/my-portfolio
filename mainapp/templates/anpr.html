{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/anpr.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="container">
    <header class="anpr-header">
        <i class="fas fa-car-alt header-icon"></i>
        <h1>Automatic Number Plate Recognition (ANPR)</h1>
        <p class="subtitle">Upload an image or capture live photo to detect the number plate.</p>
    </header>

    <main class="anpr-section">
        
        <div class="mode-toggle-buttons">
            <button id="mode-file" class="btn btn-mode active"><i class="fas fa-upload"></i> Browse Image</button>
            <button id="mode-camera" class="btn btn-mode"><i class="fas fa-camera"></i> Capture Photo</button>
        </div>

        <div class="upload-area card shadow-hover" id="file-upload-container">
            <form id="upload-form-file" method="post" enctype="multipart/form-data" action="{% url 'process_anpr' %}">
                {% csrf_token %}
                
                <label for="image-upload" class="upload-label drop-zone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span class="upload-text">Click to Browse or **Drag & Drop** Vehicle Image Here</span>
                    <span class="file-type-hint">Supported formats: JPG, PNG</span>
                    <input type="file" id="image-upload" name="vehicle_image" accept="image/*" hidden>
                </label>
            </form>
        </div>

        <div class="upload-area card shadow-hover hidden" id="camera-capture-container">
            <div class="camera-feed-box">
                <video id="video-feed" autoplay playsinline class="hidden"></video>
                <canvas id="canvas-capture" class="hidden"></canvas>
                <p id="camera-status">Click 'Start Camera' to begin.</p>
            </div>
            
            <div class="camera-controls">
                <button id="start-camera-btn" class="btn btn-primary"><i class="fas fa-video"></i> Start Camera</button>
                <button id="capture-photo-btn" class="btn btn-primary hidden" disabled><i class="fas fa-camera-retro"></i> Capture Photo</button>
            </div>
            
            <form id="upload-form-camera" method="post" action="{% url 'process_anpr' %}" class="hidden">
                {% csrf_token %}
                <input type="hidden" id="camera-image-data" name="vehicle_image_data">
            </form>
        </div>
        
        <button type="button" id="main-process-btn" class="btn btn-process-main" disabled>
            <i class="fas fa-eye"></i> PROCESS AND RECOGNIZE NUMBER PLATE
        </button>
        
        <div class="result-area">
            
            <div class="image-preview-card card">
                <h2 class="card-title"><i class="fas fa-image"></i> Image Preview</h2>
                <div id="image-container">
                    {% if image_base64 %}
                        <img id="preview-image" src="data:image/jpeg;base64,{{ image_base64 }}" alt="Uploaded Image Preview">
                        <p id="placeholder-text" class="placeholder-text hidden">No Image Selected</p>
                    {% else %}
                        <img id="preview-image" src="#" alt="Image Preview" class="hidden">
                        <p id="placeholder-text" class="placeholder-text">No Image Selected</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="recognition-card card">
                <h2 class="card-title"><i class="fas fa-search-dollar"></i> Recognition Data</h2>
                
                <div class="result-box plate-display-box">
                    <p class="label">Detected Plate Number:</p>
                    <div id="plate-result-wrapper">
                        <p id="plate-result">{{ plate_result|default:"---" }}</p>
                    </div>
                </div>
                
                <div class="result-box status-display-box">
                    <p class="label">Processing Status:</p>
                    <p id="status-message" class="status-text {{ status_class|default:'success' }}">
                        {{ status_message|default:"Ready to upload" }}
                    </p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Global Elements ---
        const previewImage = document.getElementById('preview-image');
        const placeholderText = document.getElementById('placeholder-text');
        const statusMessage = document.getElementById('status-message');
        const mainProcessBtn = document.getElementById('main-process-btn');
        
        // --- File Mode Elements ---
        const fileContainer = document.getElementById('file-upload-container');
        const imageUploadFile = document.getElementById('image-upload');
        const uploadLabel = document.querySelector('.upload-label'); 
        const formFile = document.getElementById('upload-form-file');

        // --- Camera Mode Elements ---
        const cameraContainer = document.getElementById('camera-capture-container');
        const videoFeed = document.getElementById('video-feed');
        const canvasCapture = document.getElementById('canvas-capture');
        const cameraStatus = document.getElementById('camera-status');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const formCamera = document.getElementById('upload-form-camera');
        const cameraImageData = document.getElementById('camera-image-data');
        
        const modeFileBtn = document.getElementById('mode-file');
        const modeCameraBtn = document.getElementById('mode-camera');
        let currentStream = null; 
        let currentMode = 'file'; 

        // --- Utility Functions ---
        function updateProcessButtonState(isEnabled, text = 'PROCESS AND RECOGNIZE NUMBER PLATE') {
            mainProcessBtn.disabled = !isEnabled;
            mainProcessBtn.innerHTML = `<i class="fas fa-eye"></i> ${text}`;
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                videoFeed.classList.add('hidden');
                cameraStatus.textContent = 'Camera stopped.';
                startCameraBtn.classList.remove('hidden');
                capturePhotoBtn.classList.add('hidden');
            }
        }

        // --- Mode Switching Logic ---
        function switchMode(mode) {
            modeFileBtn.classList.remove('active');
            modeCameraBtn.classList.remove('active');
            fileContainer.classList.add('hidden');
            cameraContainer.classList.add('hidden');
            
            stopCamera(); 

            if (mode === 'file') {
                currentMode = 'file';
                modeFileBtn.classList.add('active');
                fileContainer.classList.remove('hidden');
                // Enable if file is already selected
                updateProcessButtonState(imageUploadFile.files.length > 0, 'PROCESS UPLOADED IMAGE');
            } else if (mode === 'camera') {
                currentMode = 'camera';
                modeCameraBtn.classList.add('active');
                cameraContainer.classList.remove('hidden');
                // Enable if photo is already captured (Base64 data exists)
                updateProcessButtonState(cameraImageData.value.length > 0, 'PROCESS CAPTURED PHOTO');
            }
        }
        
        modeFileBtn.addEventListener('click', () => switchMode('file'));
        modeCameraBtn.addEventListener('click', () => switchMode('camera'));

        // --- Camera Logic ---
        startCameraBtn.addEventListener('click', async () => {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Prefer mobile rear camera
                });
                
                videoFeed.srcObject = currentStream;
                videoFeed.classList.remove('hidden');
                canvasCapture.classList.add('hidden');
                cameraStatus.textContent = 'Camera feed active. Capture photo when ready.';
                startCameraBtn.classList.add('hidden');
                capturePhotoBtn.classList.remove('hidden');
                updateProcessButtonState(false); // Disable processing until photo is taken
            } catch (err) {
                console.error("Camera access error: ", err);
                cameraStatus.textContent = `Error: Cannot access camera. (${err.name})`;
                statusMessage.className = 'status-text error';
            }
        });

        capturePhotoBtn.addEventListener('click', () => {
            if (!currentStream) return;

            // Draw video frame onto canvas
            canvasCapture.width = videoFeed.videoWidth;
            canvasCapture.height = videoFeed.videoHeight;
            const context = canvasCapture.getContext('2d');
            context.drawImage(videoFeed, 0, 0, canvasCapture.width, canvasCapture.height);
            
            // Convert canvas image to Base64 data URL
            const imageDataURL = canvasCapture.toDataURL('image/jpeg', 0.9);

            cameraImageData.value = imageDataURL;

            // Display captured image in the preview box
            previewImage.src = imageDataURL;
            previewImage.classList.remove('hidden');
            placeholderText.classList.add('hidden');

            stopCamera(); // Stop video feed after capture
            
            cameraStatus.textContent = 'Photo captured successfully!';
            updateProcessButtonState(true, 'PROCESS CAPTURED PHOTO');
        });

        // --- File Upload Logic ---
        function handleFile(file) {
             if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.classList.remove('hidden');
                    placeholderText.classList.add('hidden');
                    statusMessage.textContent = 'Image selected. Click "Process...".';
                    statusMessage.className = 'status-text success';
                };
                reader.readAsDataURL(file);
                updateProcessButtonState(true, 'PROCESS UPLOADED IMAGE');
            } else {
                previewImage.classList.add('hidden');
                placeholderText.classList.remove('hidden');
                updateProcessButtonState(false);
                statusMessage.textContent = 'Please select a valid image file.';
                statusMessage.className = 'status-text error';
            }
        }
        
        imageUploadFile.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile(this.files[0]);
            } else {
                handleFile(null); 
            }
        });

        // --- Drag & Drop logic (Remains the same) ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            document.body.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false); 
        });

        ['dragenter', 'dragover'].forEach(eventName => { uploadLabel.addEventListener(eventName, () => { uploadLabel.style.borderColor = 'var(--secondary-color)'; uploadLabel.style.backgroundColor = 'rgba(136, 211, 206, 0.1)'; }, false); });
        ['dragleave', 'drop'].forEach(eventName => { uploadLabel.addEventListener(eventName, () => { uploadLabel.style.borderColor = 'var(--primary-color)'; uploadLabel.style.backgroundColor = 'transparent'; }, false); });

        uploadLabel.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                imageUploadFile.files = files; 
                handleFile(files[0]);
            }
        }, false);
        
        // ==================================================
        // NEW: MAIN PROCESS BUTTON LISTENER
        // ==================================================
        mainProcessBtn.addEventListener('click', function() {
            if (mainProcessBtn.disabled) return;
            
            // Set temporary loading state
            mainProcessBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing... Please wait.';
            mainProcessBtn.disabled = true;

            // Determine which form to submit
            if (currentMode === 'file') {
                formFile.submit();
            } else if (currentMode === 'camera') {
                formCamera.submit();
            }
        });

        // --- Initialization ---
        switchMode('file'); 
    });
</script>
{% endblock %}